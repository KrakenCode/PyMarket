{% extends "base.html" %}

  {% block content %}

  <style>
  td.details-control {
    background: url('https://datatables.net/examples/resources/details_open.png') no-repeat center center;
    cursor: pointer;
  }
  tr.shown td.details-control {
      background: url('https://datatables.net/examples/resources/details_close.png') no-repeat center center;
      color:red;
  }
</style>

<div class="container-fluid">
  <h1 align="center">This is the Sales page</h1>

  <div class="container">
    <div class="table-responsive">
        <table id="sales_table" style="width:100%" class="table table-striped table-bordered"></table>
        
    </div>
  </div>
</div>
<script>

//Listener for checkbx
function toggleCheckbox(productID, SKU, quantity)
{
  var stringy = "" + productID + SKU;
  
  document.getElementById(stringy).disabled = true;

  $.ajax({
              type: "POST",
              url: "/fillproductdata",
              data: {row_SKU: SKU, row_quantity: quantity},
              dataType: "text",
              success: function(response) {
                console.log("ajax success");
                
                var obj = JSON.parse(response);
                
                div
                  .html( format_table(obj.data, data[0]) )
                  
              },
              error: function(err) {
                  console.log(err);
              }
          });


}

function format_table( d, OrderID ) {

    // `d` is the original data object for the row
    var str = '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">';
    str += 	'<tr>'+ 
    		'<td>'+'SKU'+'</td>'+
        	'<td>'+'Name'+'</td>'+
        	'<td>'+'Location'+'</td>'+
        	'<td>'+'Quantity'+'</td>'+
        	'<td>'+'Status'+'</td>'
     		+'</tr>';   

    var i;
    for(i=0; i < d.length; i++)
    {
    str +=	'<tr>'+
       		'<td>'+d[i][0]+'</td>'+
        	'<td>'+d[i][1]+'</td>'+
        	'<td>'+d[i][2]+'</td>'+
        	'<td>'+d[i][3]+'</td>'+
        	'<td><input id="'+ OrderID +''+ d[i][0] + '" type="checkbox" onclick="toggleCheckbox('+ OrderID +',' + d[i][0] + ','+ d[i][3] +')">'+'</td>'+
        	'</tr>';
    }
    str += '</table>';

   

    return str;
  }

  function getProductTable ( data ) {

     var div = $('<div/>')
        .addClass( 'loading' )
        .text( 'Loading...' );

    

    var product_data;
    $.ajax({
              type: "POST",
              url: "/getproductdata",
              data: {row_OrderId: data[0]},
              dataType: "text",
              success: function(response) {
                console.log("ajax success");
                
                var obj = JSON.parse(response);
                
                div
                  .html( format_table(obj.data, data[0]) )
                  .removeClass( 'Loading' );
              },
              error: function(err) {
                  console.log(err);
              }
          });
      return div;
  }

  $(document).ready(function() {
    var sales_data = {{sales|tojson}};
   
    console.log(typeof(sales_data));
    console.log(sales_data);
    var table = $('#sales_table').DataTable( {
      data: sales_data, 

      "columns": [ {
          "targets": 0,
          "className":      'details-control',
          "data": null,
          "defaultContent": ''
        },
       
        { title: "Order ID", "data": 0},
        { title: "Customer ID",  "data": 1},
        { title: "Created Date",  "data": 2}, 
        {
            "targets": -1,
            title: "Status",
            "data": null,
            "defaultContent": '<button type="button" name="filledButton" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#filledModal">Filled</button>'
           
        }
      
      
      /*"columnDefs": [ {
          "targets": -1,
          "className":      'details-control',
          "orderable":      false,
          "data":           null,
          "defaultContent": '',
          "render": function () {
           return '<i class="fa a-plus-square" aria-hidden="true"></i>';
                     }
      } ]*/
      ]
    } );
    
  

    $('#sales_table tbody').on('click', 'td.details-control', function () {
        var tr = $(this).closest('tr');
        var row = table.row( tr );
 
        if ( row.child.isShown() ) {
            // This row is already open - close it
            row.child.hide();
            tr.removeClass('shown');
        }
        else {
            // Open this row
            
            row.child( getProductTable(row.data()) ).show();
            tr.addClass('shown');
        }
    } );

  } );

</script>
{% endblock %}
